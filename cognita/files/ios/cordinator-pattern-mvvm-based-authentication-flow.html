<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Integrate the Coordinator Pattern in your MVVM-based authentication flow</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../index.js"></script>
</head>
<body>
    <header>
        <nav class="corporate-nav">
            <div class="nav-container">
                <div class="title-header">
                    <h1 class="title">Integrate the Coordinator Pattern in your MVVM-based authentication flow</h1>
                    <p class="subtitle">Let‚Äôs now integrate the Coordinator pattern into your MVVM-based authentication flow. This pattern helps separate navigation logic from the view controllers, improving modularity, testability, and maintainability.</p>
                </div>        
            </div>
        </nav>
    </header>

    <main>
        <section>
            <h2>‚úÖ What You‚Äôll Get</h2>
            <p>New structure:</p>
            <pre><code>
/Coordinators
    ‚îî‚îÄ‚îÄ AppCoordinator.swift
    ‚îî‚îÄ‚îÄ AuthCoordinator.swift
/ViewModels
    ‚îî‚îÄ‚îÄ AuthViewModel.swift
/Views
    ‚îî‚îÄ‚îÄ ViewController.swift
            </code></pre>
        </section>

        <section>
            <h2>üß© 1. Coordinator Protocol</h2>
            <pre><code>
// Coordinators/Coordinator.swift
import UIKit

protocol Coordinator {
    var navigationController: UINavigationController { get set }
    func start()
}                
            </code></pre>
        </section>

        <section>
            <h2>üöÄ 2. AppCoordinator</h2>
            <p>The main entry point of the app that decides which flow to start.</p>
            <pre><code>
// Coordinators/AppCoordinator.swift
import UIKit

class AppCoordinator: Coordinator {
    var navigationController: UINavigationController

    init(navigationController: UINavigationController) {
        self.navigationController = navigationController
    }

    func start() {
        let authCoordinator = AuthCoordinator(navigationController: navigationController)
        authCoordinator.start()
    }
}
            </code></pre>
        </section>

        <section>
            <h2>üîê 3. AuthCoordinator</h2>
            <p>Handles the Google Sign-In flow.</p>
            <pre><code>
// Coordinators/AuthCoordinator.swift
import UIKit
import FirebaseAuth

class AuthCoordinator: Coordinator {
    var navigationController: UINavigationController

    init(navigationController: UINavigationController) {
        self.navigationController = navigationController
    }

    func start() {
        let viewModel = AuthViewModel()
        let viewController = AuthViewController(viewModel: viewModel)
        viewModel.onSignInSuccess = { [weak self] user in
            print("User signed in: \(user.displayName ?? "")")
            // You can push to another flow here, e.g., MainCoordinator
        }
        viewModel.onSignInFailure = { error in
            print("Sign-in error: \(error)")
        }

        navigationController.pushViewController(viewController, animated: false)
    }
}
            </code></pre>
        </section>

        <section>
            <h2>üß† 4. AuthViewModel</h2>
            <p>Same as before:</p>
            <pre><code>
// ViewModels/AuthViewModel.swift
import Foundation
import FirebaseAuth
import GoogleSignIn
import UIKit

class AuthViewModel {
    var onSignInSuccess: ((User) -> Void)?
    var onSignInFailure: ((String) -> Void)?

    func signInWithGoogle(presentingViewController: UIViewController) {
        GIDSignIn.sharedInstance.signIn(withPresenting: presentingViewController) { result, error in
            if let error = error {
                self.onSignInFailure?("Google Sign-In failed: \(error.localizedDescription)")
                return
            }

            guard let user = result?.user else {
                self.onSignInFailure?("User not found")
                return
            }

            guard let idToken = user.idToken?.tokenString else {
                self.onSignInFailure?("ID Token is nil")
                return
            }

            let credential = GoogleAuthProvider.credential(withIDToken: idToken, accessToken: user.accessToken.tokenString)

            Auth.auth().signIn(with: credential) { authResult, error in
                if let error = error {
                    self.onSignInFailure?("Firebase Auth failed: \(error.localizedDescription)")
                } else if let user = authResult?.user {
                    self.onSignInSuccess?(user)
                } else {
                    self.onSignInFailure?("User object is nil")
                }
            }
        }
    }
}
            </code></pre>
        </section>

        <section>
            <h2>üéØ 5. AuthViewController (formerly ViewController)</h2>
            <pre><code>
// Views/AuthViewController.swift
import UIKit
import GoogleSignIn

class AuthViewController: UIViewController {

    private var viewModel: AuthViewModel

    init(viewModel: AuthViewModel) {
        self.viewModel = viewModel
        super.init(nibName: nil, bundle: nil)
    }

    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
    }

    private func setupUI() {
        let signInButton = GIDSignInButton()
        signInButton.addTarget(self, action: #selector(signInTapped), for: .touchUpInside)
        signInButton.center = view.center
        view.addSubview(signInButton)
    }

    @objc private func signInTapped() {
        viewModel.signInWithGoogle(presentingViewController: self)
    }
}
            </code></pre>
        </section>

        <section>
            <h2>üèÅ 6. SceneDelegate (or AppDelegate)</h2>
            <p>Start the app with your coordinator.</p>
            <pre><code>
// SceneDelegate.swift
import UIKit

class SceneDelegate: UIResponder, UIWindowSceneDelegate {

    var window: UIWindow?
    var appCoordinator: AppCoordinator?

    func scene(_ scene: UIScene,
                willConnectTo session: UISceneSession,
                options connectionOptions: UIScene.ConnectionOptions) {

        guard let windowScene = scene as? UIWindowScene else { return }

        let navController = UINavigationController()
        appCoordinator = AppCoordinator(navigationController: navController)
        appCoordinator?.start()

        window = UIWindow(windowScene: windowScene)
        window?.rootViewController = navController
        window?.makeKeyAndVisible()
    }
}                
            </code></pre>
        </section>

        <section>
            <h2>‚úÖ Summary of Benefits</h2>
            <ul>
                <li>‚úÖ Navigation logic is now handled by Coordinators.</li>
                <li>‚úÖ ViewControllers are clean, only handle UI.</li>
                <li>‚úÖ ViewModels handle business logic.</li>
                <li>‚úÖ Easier to extend (e.g., MainAppCoordinator after login).</li>
            </ul>
        </section>

        <section>
            <p>let‚Äôs add a Home screen and make the app transition to it after a successful login using the Coordinator pattern. We'll also implement a logout flow that brings the user back to the login screen.</p>
            <p>‚úÖ Goal</p>
            <p>After Google Sign-In succeeds:</p>
            <ol>
                <li>Navigate to a HomeViewController.</li>
                <li>HomeViewController has a logout button.</li>
                <li>Tapping logout signs the user out and routes back to the login screen.</li>
            </ol>
        </section>

        <section>
            <h2>üß≠ Updated Architecture</h2>
            <pre><code>
/Coordinators
‚îú‚îÄ‚îÄ AppCoordinator.swift
‚îú‚îÄ‚îÄ AuthCoordinator.swift
‚îú‚îÄ‚îÄ MainCoordinator.swift ‚úÖ
/ViewModels
‚îú‚îÄ‚îÄ AuthViewModel.swift
‚îú‚îÄ‚îÄ HomeViewModel.swift ‚úÖ
/Views
‚îú‚îÄ‚îÄ AuthViewController.swift
‚îú‚îÄ‚îÄ HomeViewController.swift ‚úÖ
            </code></pre>

            <h2>‚úÖ Step 1: Create MainCoordinator.swift</h2>
            <p>Handles post-login flow.</p>
            <pre><code>
// Coordinators/MainCoordinator.swift
import UIKit
import FirebaseAuth

class MainCoordinator: Coordinator {
    var navigationController: UINavigationController

    init(navigationController: UINavigationController) {
        self.navigationController = navigationController
    }

    func start() {
        let viewModel = HomeViewModel()
        let homeVC = HomeViewController(viewModel: viewModel)

        viewModel.onLogout = { [weak self] in
            self?.navigationController.popToRootViewController(animated: true)
        }

        navigationController.pushViewController(homeVC, animated: true)
    }
}
            </code></pre>
        </section>

        <section>
            <h2>‚úÖ Step 2: Update AuthCoordinator.swift</h2>
            <p>Add navigation to MainCoordinator on successful sign-in.</p>
            <pre><code>
// Coordinators/AuthCoordinator.swift
import UIKit
import FirebaseAuth

class AuthCoordinator: Coordinator {
    var navigationController: UINavigationController

    init(navigationController: UINavigationController) {
        self.navigationController = navigationController
    }

    func start() {
        let viewModel = AuthViewModel()
        let viewController = AuthViewController(viewModel: viewModel)

        viewModel.onSignInSuccess = { [weak self] user in
            print("User signed in: \(user.displayName ?? "")")
            self?.goToMainApp()
        }

        viewModel.onSignInFailure = { error in
            print("Sign-in error: \(error)")
        }

        navigationController.setViewControllers([viewController], animated: false)
    }

    private func goToMainApp() {
        let mainCoordinator = MainCoordinator(navigationController: navigationController)
        mainCoordinator.start()
    }
}
            </code></pre>
        </section>

        <section>
            <h2>‚úÖ Step 3: Create HomeViewModel.swift</h2>
            <pre><code>
// ViewModels/HomeViewModel.swift
import Foundation
import FirebaseAuth

class HomeViewModel {
    var onLogout: (() -> Void)?

    func logout() {
        do {
            try Auth.auth().signOut()
            onLogout?()
        } catch {
            print("Logout failed: \(error.localizedDescription)")
        }
    }
}
            </code></pre>
        </section>

        <section>
            <h2>‚úÖ Step 4: Create HomeViewController.swift</h2>
            <pre><code>
// Views/HomeViewController.swift
import UIKit

class HomeViewController: UIViewController {

    private let viewModel: HomeViewModel

    init(viewModel: HomeViewModel) {
        self.viewModel = viewModel
        super.init(nibName: nil, bundle: nil)
        self.title = "Home"
    }

    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .systemBackground
        setupLogoutButton()
    }

    private func setupLogoutButton() {
        let button = UIButton(type: .system)
        button.setTitle("Logout", for: .normal)
        button.addTarget(self, action: #selector(logoutTapped), for: .touchUpInside)
        button.translatesAutoresizingMaskIntoConstraints = false

        view.addSubview(button)
        NSLayoutConstraint.activate([
            button.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            button.centerYAnchor.constraint(equalTo: view.centerYAnchor)
        ])
    }

    @objc private func logoutTapped() {
        viewModel.logout()
    }
}
            </code></pre>
        </section>

        <section>
            <h2>‚úÖ Step 5: Update SceneDelegate (for completeness)</h2>
            <p>Make sure your root navigation controller is always reused.</p>
            <pre><code>
// SceneDelegate.swift
func scene(_ scene: UIScene,
           willConnectTo session: UISceneSession,
           options connectionOptions: UIScene.ConnectionOptions) {

    guard let windowScene = (scene as? UIWindowScene) else { return }

    let navController = UINavigationController()
    let appCoordinator = AppCoordinator(navigationController: navController)
    self.appCoordinator = appCoordinator

    appCoordinator.start()

    window = UIWindow(windowScene: windowScene)
    window?.rootViewController = navController
    window?.makeKeyAndVisible()
}
            </code></pre>
        </section>

        <section>
            <h2>üéâ Now You Have:</h2>
            <ul>
                <li>‚úÖ A clean MVVM + Coordinator architecture.</li>
                <li>‚úÖ Google Sign-In integrated via ViewModel.</li>
                <li>‚úÖ Navigation logic in Coordinators, not ViewControllers.</li>
                <li>‚úÖ A Home screen with logout that resets back to login.</li>
            </ul>
        </section>

        <section>
            <h2>‚ûï Want More?</h2>
            <p>I can also help you:</p>
            <ul>
                <li>Add deep linking to jump into authenticated state.</li>
                <li>Persist auth state across app launches.</li>
                <li>Show a splash screen and auto-login if user is already authenticated.</li>
            </ul>
        </section>
    </main>

    <footer>
        <p class="copyright">
            &copy; <span id="year"></span> Aether Corp. All rights reserved.
        </p>
    </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>auth.middleware.js</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../index.js"></script>
</head>
<body>
    <header>
        <nav class="corporate-nav">
            <div class="nav-container">
                <div class="title-header">
                    <h1 class="title">auth.middleware.js</h1>
                    <p class="subtitle">You've provided middleware functions for validating request headers and verifying user tokens in a Node.js backend application. Here's a breakdown and some suggestions for improvements and best practices.</p>
                </div>        
            </div>
        </nav>
    </header>

    <main>
        <section>
            <pre><code>
const UserRepo = require('./../../../modules/user/repositories/user.repository');
const GoogleService = require('./../../../common/services/google.service');

async function validTokenParameter(req, res, next) {
    console.log('>>>>>',req.url);
    console.log('>>>>>',req.headers);
    if (typeof req.headers.platform === 'undefined' || typeof req.headers.access_token === 'undefined' ||
        typeof req.headers.device_id === 'undefined' || typeof req.headers.device_token_id === 'undefined' ||
        typeof req.headers.email === 'undefined') {
        return res.status(403).send({ status: false, statusCode: 403, message: 'Missing required headers parameters.', data: [] });
    } else {
        if (req.headers.platform.toLowerCase() !== 'ios' && (req.headers.platform.toLowerCase() !== 'android')) {
            req.headers.platform = 'web';
        }
        GoogleService.instance.setPlatform(req.headers.platform);
        next();
    }
}

exports.validTokenParameter = validTokenParameter;

exports.validCodeParameter = async (req, res, next) => {
    console.log(req.headers);
    if (typeof req.headers.platform === 'undefined' || typeof req.headers.code === 'undefined' ||
        typeof req.headers.device_id === 'undefined' || typeof req.headers.device_token_id === 'undefined'
        ) {
        return res.status(403).send({ status: false, statusCode: 403, message: 'Missing required headers parameters.', data: [] });
    } else {
        if (req.headers.platform.toLowerCase() !== 'ios' && (req.headers.platform.toLowerCase() !== 'android')) {
            req.headers.platform = 'web';
        }
        GoogleService.instance.setPlatform(req.headers.platform);
        next();
    }
}

async function userTokenMustExist(req, res, next) {
    // Run header validation
    if (
        typeof req.headers.platform === 'undefined' ||
        typeof req.headers.access_token === 'undefined' ||
        typeof req.headers.device_id === 'undefined' ||
        typeof req.headers.device_token_id === 'undefined' ||
        typeof req.headers.email === 'undefined'
    ) {
        return res.status(403).send({ status: false, statusCode: 403, message: 'Missing required headers parameters.', data: [] });
    }

    // Normalize platform
    if (req.headers.platform.toLowerCase() !== 'ios' && req.headers.platform.toLowerCase() !== 'android') {
        req.headers.platform = 'web';
    }

    GoogleService.instance.setPlatform(req.headers.platform);

    // Now check user token
    const user = await UserRepo.findUserToken(
        req.headers.email,
        req.headers.device_id,
        req.headers.platform,
        req.headers.access_token
    );

    if (!user) {
        return res.status(403).send({ status: false, statusCode: 403, message: 'Invalid device.', data: [] });
    }

    req.user = user;
    next();  // Only call next if all above succeeds
}

exports.userTokenMustExist = userTokenMustExist;

exports.isLogon = async (req, res, next) => {
    try {
        await userTokenMustExist(req, res, async () => {
            // Check if token is still valid
            const token = req.user?.UserToken;

            if (!token) {
                return res.status(403).send({
                    status: false,
                    statusCode: 403,
                    message: 'Missing required headers parameters. User token not found',
                    data: []
                });
            }

            const now = Date.now();
            const expiration = new Date(token.ExpirationDate).getTime();

            if ((now - expiration) < 3600000) {
                GoogleService.instance.setCredentials({
                    access_token: token.AccessToken,
                    id_token: token.IdToken,
                    refresh_token: token.RefreshToken
                });

                return next();
            } else {
                return res.status(403).send({
                    status: false,
                    statusCode: 403,
                    message: 'Token was expired.',
                    data: []
                });
            }
        });
    } catch (err) {
        return res.status(500).send({
            status: false,
            statusCode: 500,
            message: 'Failed to validate user login.',
            data: []
        });
    }
};
            </code></pre>
            <h2>âœ… Overview of What Each Middleware Does</h2>
            <ol>
                <li>
                    validTokenParameter
                    <ul>
                        <li>Checks if essential headers (platform, access_token, device_id, device_token_id, email) are present.</li>
                        <li>Defaults platform to web if not ios or android.</li>
                        <li>Sets platform in GoogleService.</li>
                    </ul>
                </li>

                <li>
                    validCodeParameter
                    <ul>
                        <li>Similar to validTokenParameter, but it expects code instead of access_token and email.</li>
                    </ul>
                </li>

                <li>
                    userTokenMustExist
                    <ul>
                        <li>Ensures headers are present and valid.</li>
                        <li>Checks if a user token exists via UserRepo.findUserToken.</li>
                        <li>Attaches user to req.user.</li>
                    </ul>
                </li>

                <li>
                    isLogon
                    <ul>
                        <li>Uses userTokenMustExist internally.</li>
                        <li>Checks if the token is still valid based on expiration.</li>
                        <li>Sets credentials in GoogleService.</li>
                    </ul>
                </li>
            </ol>
        </section>
    </main>

    <footer>
        <p class="copyright">
            &copy; <span id="year"></span> Aether Corp. All rights reserved.
        </p>
    </footer>
</body>
</html>
